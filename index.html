<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåä H·ªá th·ªëng gi√°m s√°t l≈© s·ªõm</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { background:#f8f9fa; color:#333; font-family:'Segoe UI', sans-serif; padding:20px; }
h2 { color:#007bff; }
.card { border-radius:15px; margin-bottom:20px; }
canvas { background:#fff; border-radius:10px; padding:10px; }
.badge { font-size:1rem; }
.latest-row { background:#d1ecf1 !important; font-weight:bold; }
.alert-level { font-weight:bold; font-size:1.1rem; margin-top:10px; }
.legend-table td, .legend-table th { vertical-align: middle; text-align:left; }
.time-label { font-size:0.9rem; color:#555; margin-top:5px; }
</style>
</head>
<body>
<div class="container-fluid">
  <div class="text-center mb-4">
    <h2>üåä H·ªá th·ªëng gi√°m s√°t l≈© s·ªõm</h2>
    <p class="text-muted">Realtime monitoring - LoRa Sensor</p>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card p-3 shadow-sm">
        <h5>üìä Bi·ªÉu ƒë·ªì d·ªØ li·ªáu c·∫£m bi·∫øn</h5>
        <canvas id="radarChart" height="120"></canvas>
        <div id="radarTime" class="time-label"></div>
        <canvas id="tempChart" height="120" class="mt-3"></canvas>
        <div id="tempTime" class="time-label"></div>
        <canvas id="humChart" height="120" class="mt-3"></canvas>
        <div id="humTime" class="time-label"></div>
        <canvas id="rainChart" height="120" class="mt-3"></canvas>
        <div id="rainTime" class="time-label"></div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3 shadow-sm">
        <h5>‚ö†Ô∏è C·∫£nh b√°o & d·ª± b√°o</h5>
        <div class="mb-2">
          <strong>Total Received:</strong> <span id="totalReceived">0</span><br>
          <strong>Total Lost:</strong> <span id="totalLost">0</span><br>
          <strong>Packet Loss (%):</strong> <span id="lossPercent">0</span><br>
        </div>
        <h6>M·ª©c c·∫£nh b√°o cu·ªëi c√πng:</h6>
        <span id="alertLevel" class="badge bg-success">0</span>
        <div class="alert-level text-primary" id="forecastText">Kh√¥ng c√≥ nguy c∆°</div>

        <div class="table-responsive mt-3">
          <table class="table table-striped table-bordered table-sm" id="packetTable">
            <thead class="table-light">
              <tr>
                <th>Seq</th><th>Radar</th><th>Temp</th><th>Humi</th>
                <th>Rain</th><th>WaterLv</th><th>Alert</th><th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const MAX_PACKETS = 50;
let packets = [];

function createChart(ctx,label,color){
  return new Chart(ctx,{
    type:'line',
    data:{labels:[], datasets:[{label:label, data:[], borderColor:color, backgroundColor:color+'33', fill:true, tension:0.3}]},
    options:{responsive:true, animation:false, scales:{y:{beginAtZero:true}}}
  });
}

const radarChart = createChart(document.getElementById('radarChart').getContext('2d'),'Radar (m/s)','#007bff');
const tempChart = createChart(document.getElementById('tempChart').getContext('2d'),'Temp (¬∞C)','#dc3545');
const humChart = createChart(document.getElementById('humChart').getContext('2d'),'Humidity (%)','#28a745');
const rainChart = createChart(document.getElementById('rainChart').getContext('2d'),'Rain (mm)','#fd7e14');

// MQTT WebSocket
const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
client.on('connect', ()=>{ console.log("MQTT connected"); client.subscribe('lora_data'); });
client.on('message', (topic,message)=>{
  try{
    const data = JSON.parse(message.toString());
    data.time = new Date().toLocaleString(); // th√™m th·ªùi gian nh·∫≠n
    addPacket(data);
  }catch(e){ console.log("Invalid JSON:", e);}
});

function addPacket(p){
  packets.unshift(p); // m·ªõi nh·∫•t l√™n ƒë·∫ßu
  if(packets.length>MAX_PACKETS) packets.pop();
  updateUI();
}

function updateUI(){
  const tbody = document.querySelector('#packetTable tbody');
  tbody.innerHTML = '';
  let lastAlert = 0;

  // B·∫£ng
  packets.forEach((p,i)=>{
    let badgeClass, badgeText;
    switch(p.alert){
      case 1: badgeClass='bg-success'; badgeText='1'; break;
      case 2: badgeClass='bg-warning text-dark'; badgeText='2'; break;
      case 3: badgeClass='bg-orange text-dark'; badgeText='3'; break;
      case 4: badgeClass='bg-danger'; badgeText='4'; break;
      default: badgeClass='bg-secondary'; badgeText=p.alert; break;
    }
    lastAlert = p.alert;
    tbody.innerHTML+=`<tr ${i===0?'class="latest-row"':''}>
      <td>${p.seq}</td><td>${p.radar.toFixed(2)}</td><td>${p.temp.toFixed(2)}</td>
      <td>${p.hum.toFixed(2)}</td><td>${p.rain.toFixed(2)}</td><td>${p.waterLv}/8</td>
      <td><span class='badge ${badgeClass}'>${badgeText}</span></td>
      <td>${p.time}</td>
    </tr>`;
  });

  // Bi·ªÉu ƒë·ªì
  const labels = packets.map(p=>p.seq);
  radarChart.data.labels = labels; radarChart.data.datasets[0].data = packets.map(p=>p.radar);
  tempChart.data.labels = labels; tempChart.data.datasets[0].data = packets.map(p=>p.temp);
  humChart.data.labels = labels; humChart.data.datasets[0].data = packets.map(p=>p.hum);
  rainChart.data.labels = labels; rainChart.data.datasets[0].data = packets.map(p=>p.rain);
  radarChart.update(); tempChart.update(); humChart.update(); rainChart.update();

  // Hi·ªÉn th·ªã th·ªùi gian m·ªõi nh·∫•t d∆∞·ªõi t·ª´ng bi·ªÉu ƒë·ªì
  if(packets[0]){
    document.getElementById('radarTime').innerText = "C·∫≠p nh·∫≠t: "+packets[0].time;
    document.getElementById('tempTime').innerText = "C·∫≠p nh·∫≠t: "+packets[0].time;
    document.getElementById('humTime').innerText = "C·∫≠p nh·∫≠t: "+packets[0].time;
    document.getElementById('rainTime').innerText = "C·∫≠p nh·∫≠t: "+packets[0].time;
  }

  // Alert
  const alertSpan = document.getElementById('alertLevel');
  alertSpan.className='badge ';
  let forecastText="Kh√¥ng c√≥ nguy c∆°";
  switch(lastAlert){
    case 1: alertSpan.classList.add('bg-success'); forecastText="Nguy c∆° th·∫•p"; break;
    case 2: alertSpan.classList.add('bg-warning','text-dark'); forecastText="Nguy c∆° trung b√¨nh"; break;
    case 3: alertSpan.classList.add('bg-orange','text-dark'); forecastText="Nguy c∆° cao"; break;
    case 4: alertSpan.classList.add('bg-danger'); forecastText="Nguy c∆° r·∫•t cao! Nguy hi·ªÉm!"; break;
    default: alertSpan.classList.add('bg-secondary'); break;
  }
  alertSpan.innerText = lastAlert;
  document.getElementById('forecastText').innerText = forecastText;

  document.getElementById('totalReceived').innerText = packets.length;
  document.getElementById('totalLost').innerText = 0;
  document.getElementById('lossPercent').innerText = 0;
}
</script>
</body>
</html>

