<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåä H·ªá th·ªëng gi√°m s√°t l≈© s·ªõm</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
body { background:#f8f9fa; color:#333; font-family:'Segoe UI', sans-serif; padding:20px; }
h2 { color:#007bff; }
.card { border-radius:15px; margin-bottom:20px; }
canvas { background:#fff; border-radius:10px; padding:10px; }
.badge { font-size:1rem; }
.latest-row { background:#d1ecf1 !important; font-weight:bold; }
.alert-level { font-weight:bold; font-size:1.1rem; margin-top:10px; }
.legend-table td, .legend-table th { vertical-align: middle; text-align:left; }
</style>
</head>
<body>
<div class="container-fluid">
  <div class="text-center mb-4">
    <h2>üåä H·ªá th·ªëng gi√°m s√°t l≈© s·ªõm</h2>
    <p class="text-muted">Realtime monitoring - LoRa Sensor</p>
  </div>

  <div class="row">
    <!-- Bi·ªÉu ƒë·ªì b√™n tr√°i -->
    <div class="col-lg-8">
      <div class="card p-3 shadow-sm">
        <h5>üìä Bi·ªÉu ƒë·ªì d·ªØ li·ªáu c·∫£m bi·∫øn</h5>
        <canvas id="radarChart" height="120"></canvas>
        <canvas id="tempChart" height="120" class="mt-3"></canvas>
        <canvas id="humChart" height="120" class="mt-3"></canvas>
        <canvas id="rainChart" height="120" class="mt-3"></canvas>
      </div>

      <!-- B·∫£ng gi·∫£i th√≠ch m·ª©c ƒë·ªô nguy hi·ªÉm -->
      <div class="card p-3 shadow-sm">
        <h5>üìù B·∫£ng m·ª©c ƒë·ªô nguy hi·ªÉm l≈©</h5>
        <table class="table table-bordered table-striped legend-table">
          <thead class="table-light">
            <tr><th>M·ª©c c·∫£nh b√°o</th><th>M√¥ t·∫£</th></tr>
          </thead>
          <tbody>
            <tr><td><span class="badge bg-success">1</span></td><td>Nguy c∆° th·∫•p: Ch·ªâ s·ªë m∆∞a & m·ª±c n∆∞·ªõc b√¨nh th∆∞·ªùng.</td></tr>
            <tr><td><span class="badge bg-warning text-dark">2</span></td><td>Nguy c∆° trung b√¨nh: C·∫ßn theo d√µi c√°c m·∫°ch n∆∞·ªõc v√† m∆∞a l·ªõn.</td></tr>
            <tr><td><span class="badge bg-orange text-dark">3</span></td><td>Nguy c∆° cao: M·ª±c n∆∞·ªõc tƒÉng, kh·∫£ nƒÉng l≈© c·ª•c b·ªô.</td></tr>
            <tr><td><span class="badge bg-danger">4</span></td><td>Nguy c∆° r·∫•t cao: L≈© l·ªõn, c·∫ßn c·∫£nh b√°o v√† chu·∫©n b·ªã di t·∫£n.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- C·∫£nh b√°o + b·∫£ng d·ªØ li·ªáu b√™n ph·∫£i -->
    <div class="col-lg-4">
      <div class="card p-3 shadow-sm">
        <h5>‚ö†Ô∏è C·∫£nh b√°o & d·ª± b√°o</h5>
        <div class="mb-2">
          <strong>Total Received:</strong> <span id="totalReceived">0</span><br>
          <strong>Total Lost:</strong> <span id="totalLost">0</span><br>
          <strong>Packet Loss (%):</strong> <span id="lossPercent">0</span><br>
        </div>
        <h6>M·ª©c c·∫£nh b√°o cu·ªëi c√πng:</h6>
        <span id="alertLevel" class="badge bg-success">0</span>
        <div class="alert-level text-primary" id="forecastText">Kh√¥ng c√≥ nguy c∆°</div>

        <div class="table-responsive mt-3">
          <table class="table table-striped table-bordered table-sm" id="packetTable">
            <thead class="table-light">
              <tr>
                <th>Seq</th><th>Radar</th><th>Temp</th><th>Humi</th>
                <th>Rain</th><th>WaterLv</th><th>Alert</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const MAX_PACKETS = 50;
let radarData=[], tempData=[], humData=[], rainData=[], labels=[];
let packets=[];

function createChart(ctx,label,color){
  return new Chart(ctx,{
    type:'line',
    data:{labels:labels,datasets:[{label:label,data:[],borderColor:color,backgroundColor:color+'33',fill:true,tension:0.3}]},
    options:{responsive:true,animation:false,scales:{y:{beginAtZero:true}}}
  });
}

const radarChart = createChart(document.getElementById('radarChart').getContext('2d'),'Radar (m/s)','#007bff');
const tempChart = createChart(document.getElementById('tempChart').getContext('2d'),'Temp (¬∞C)','#dc3545');
const humChart = createChart(document.getElementById('humChart').getContext('2d'),'Humidity (%)','#28a745');
const rainChart = createChart(document.getElementById('rainChart').getContext('2d'),'Rain (mm)','#fd7e14');

// MQTT setup
const client = mqtt.connect('wss://broker.hivemq.com:8000/mqtt');
client.on('connect', () => { console.log("MQTT connected"); client.subscribe('lora_data'); });
client.on('message', (topic, message) => {
  const data = JSON.parse(message.toString());
  addPacket(data);
});

function addPacket(p){
  packets.push(p);
  if(packets.length>MAX_PACKETS) packets.shift();
  updateUI();
}

function updateUI(){
  // Update table
  const tbody=document.querySelector('#packetTable tbody');
  tbody.innerHTML='';
  let lastAlert = 0;
  packets.forEach((p,i)=>{
    let badgeClass, badgeText;
    switch(p.alert){
      case 1: badgeClass='bg-success'; badgeText='1'; break;
      case 2: badgeClass='bg-warning text-dark'; badgeText='2'; break;
      case 3: badgeClass='bg-orange text-dark'; badgeText='3'; break;
      case 4: badgeClass='bg-danger'; badgeText='4'; break;
      default: badgeClass='bg-secondary'; badgeText=p.alert; break;
    }
    lastAlert = p.alert;
    tbody.innerHTML+=`<tr ${i===packets.length-1?'class="latest-row"':''}>
      <td>${p.seq}</td><td>${p.radar.toFixed(2)}</td><td>${p.temp.toFixed(2)}</td>
      <td>${p.hum.toFixed(2)}</td><td>${p.rain.toFixed(2)}</td><td>${p.waterLv}/8</td>
      <td><span class='badge ${badgeClass}'>${badgeText}</span></td>
    </tr>`;
  });

  // Update charts
  labels.length=0; radarData.length=0; tempData.length=0; humData.length=0; rainData.length=0;
  packets.forEach((p,i)=>{
    labels.push(i+1);
    radarData.push(p.radar); tempData.push(p.temp); humData.push(p.hum); rainData.push(p.rain);
  });
  radarChart.update(); tempChart.update(); humChart.update(); rainChart.update();

  // Update alert
  const alertSpan = document.getElementById('alertLevel');
  alertSpan.className = 'badge ';
  let forecastText = "Kh√¥ng c√≥ nguy c∆°";
  switch(lastAlert){
    case 1: alertSpan.classList.add('bg-success'); forecastText="Nguy c∆° th·∫•p"; break;
    case 2: alertSpan.classList.add('bg-warning','text-dark'); forecastText="Nguy c∆° trung b√¨nh"; break;
    case 3: alertSpan.classList.add('bg-orange','text-dark'); forecastText="Nguy c∆° cao"; break;
    case 4: alertSpan.classList.add('bg-danger'); forecastText="Nguy c∆° r·∫•t cao! Nguy hi·ªÉm!"; break;
    default: alertSpan.classList.add('bg-secondary'); break;
  }
  alertSpan.innerText = lastAlert;
  document.getElementById('forecastText').innerText = forecastText;

  // Update totals
  document.getElementById('totalReceived').innerText = packets.length;
  document.getElementById('totalLost').innerText = 0; // Kh√¥ng t√≠nh m·∫•t g√≥i MQTT ·ªü client
  document.getElementById('lossPercent').innerText = 0;
}
</script>
</body>
</html>

